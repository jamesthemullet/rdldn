---
import BaseLayout from "../layouts/BaseLayout.astro";
import { organiseComments } from "../lib/utils";
import type { Page, Size } from "../types";
import "../styles/post.css";
import Comments from "../components/comments.astro";
import Newsletter from "../components/newsletter.astro";
import logo3 from "../images/logo-3.png";
import { fetchGraphQL } from "../lib/api";
import { getSinglePageData } from "../lib/getSinglePageData";

export const prerender = true;

import GET_ALL_PAGES from "../lib/queries/getAllPages";

const variables = { id: "10368" };
const singlePage = await getSinglePageData({ variables });

type PageWithFeaturedImage = Page & { featuredImage: string };

let allPages: Page[] = [];
let allBestListPages: Page[] = [];
let bestRoasts: Array<PageWithFeaturedImage> = [];

try {
  const response = await fetchGraphQL(GET_ALL_PAGES);
  allPages = response?.pages?.nodes
    ?.map((page: Page) => {
      const featuredImage = page.featuredImage?.node;
      const smallImage =
        featuredImage?.mediaDetails?.sizes.find(
          (size: Size) => size.name === "homepage"
        )?.sourceUrl || featuredImage?.sourceUrl;

      return {
        ...page,
        featuredImageUrl: smallImage,
      };
    })
    .filter(Boolean);

  const bestAreaPages = allPages.filter(
    (page: Page) => page?.highlights?.tag === "best-area"
  );

  const bestLocationPages = allPages.filter(
    (page: Page) => page?.highlights?.tag === "best-location"
  );

  const bestPages = allPages.filter(
    (page: Page) => page?.highlights?.tag === "best"
  );

  allBestListPages = [...bestAreaPages, ...bestLocationPages, ...bestPages];

  bestRoasts = allBestListPages.map((page: Page) => ({
    ...page,
    featuredImage: page.featuredImage?.node?.sourceUrl,
  })) as Array<PageWithFeaturedImage>;
} catch (error) {
  console.error("Error fetching features data:", error);
}

const threadedComments = organiseComments(singlePage.comments.nodes);
---

<BaseLayout
  pageTitle={singlePage.title}
  description={singlePage?.seo?.opengraphDescription}
  opengraphImage={singlePage?.seo?.opengraphImage?.sourceUrl}
>
  <div class="image-container">
    <img
      src={singlePage?.featuredImage?.node?.sourceUrl}
      alt={singlePage.title}
      width={5000}
      height={5000}
      class="featured-image"
      loading="eager"
    />
    <div class="copyright-overlay">
      &copy; {new Date().getFullYear()} Roast Dinners in London. All rights reserved.
    </div>
  </div>
  <section class="post-title">
    <h2>{singlePage.title}</h2>
  </section>
  <div class="container">
    <div set:html={singlePage.content} />

    <section class="other-list">
      <h3>Best Roasts In...</h3>
      <ul>
        {
          bestRoasts
            .filter((post) => !post.title?.toLowerCase().includes("line"))
            .map((post, index) => (
              <li class="heading">
                <h3>
                  <a href={`/${post?.slug}`} rel="noopener noreferrer">
                    <Fragment set:html={post?.title} />
                  </a>
                </h3>
                <a
                  href={`/${post?.slug}`}
                  rel="noopener noreferrer"
                  class="featured-image"
                >
                  <img
                    src={post?.featuredImageUrl}
                    alt={`Photo of the roast dinner at ${post?.title}`}
                    width="400"
                    height="300"
                    loading="lazy"
                  />
                </a>
              </li>
            ))
        }
      </ul>
    </section>

    <section class="other-list">
      <h3>Best Roast Dinners on Tube Lines</h3>
      <ul>
        {
          bestRoasts
            .filter((post) => post.title?.toLowerCase().includes("line"))
            .map((post, index) => (
              <li class="heading">
                <h3>
                  <a href={`/${post?.slug}`} rel="noopener noreferrer">
                    <Fragment set:html={post?.title} />
                  </a>
                </h3>
                <a
                  href={`/${post?.slug}`}
                  rel="noopener noreferrer"
                  class="featured-image"
                >
                  <img
                    src={post?.featuredImageUrl}
                    alt={`Photo of the roast dinner at ${post?.title}`}
                    width="400"
                    height="300"
                    loading={index === 0 ? "eager" : "lazy"}
                  />
                </a>
              </li>
            ))
        }
      </ul>
    </section>

    <Newsletter />
    <Comments threadedComments={threadedComments} postId={singlePage.pageId} />
  </div>
</BaseLayout>
