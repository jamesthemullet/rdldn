---
export const prerender = true;

export const response = {
  headers: {
    "Cache-Control": "public, s-maxage=86400, stale-while-revalidate=31536000"
  }
};

import BaseLayout from "../layouts/BaseLayout.astro";
import SINGLE_PAGE_QUERY from "../lib/queries/singlePageBySlug";
import SINGLE_POST_QUERY from "../lib/queries/singlePostBySlug";
import { organiseComments } from "../lib/utils";
import "../styles/post.css";
import Comments from "../components/comments.astro";
import Newsletter from "../components/newsletter.astro";
import RoastByTagSection from "../components/roastByTagSection/roast-by-tag-section.astro";
import logo3 from "../images/logo-3.png";
import { toOwnerSlug } from "../lib/ownerSlug";

export async function getStaticPaths() {
  const allPosts = [];
  const allPages = [];
  let hasNextPage = true;
  let endCursor = null;
  const ALL_POST_SLUGS_QUERY = `
  query AllSlugs($first: Int!, $after: String) {
    posts(first: $first, after: $after) {
      nodes {
        slug
      }
      pageInfo {
        hasNextPage
        endCursor
      }
    }
  }
`;

const ALL_PAGE_SLUGS_QUERY = `
  query AllPageSlugs($first: Int!, $after: String) {
    pages(first: $first, after: $after) {
      nodes {
        slug
      }
      pageInfo {
        hasNextPage
        endCursor
      }
    }
  }
`;

  while (hasNextPage) {
    const response: Response = await fetch(
      "https://blog.rdldn.co.uk/graphql",
      {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          query: ALL_POST_SLUGS_QUERY,
          variables: {
            first: 100,
            after: endCursor,
          },
        }),
      }
    );

    const { data } = await response.json();
    const posts = data.posts?.nodes;


    if (!Array.isArray(posts)) {
      console.warn("Warning: posts is not an array", posts, data);
    } else {
      allPosts.push(...posts);
    }

    hasNextPage = data.posts?.pageInfo?.hasNextPage ?? false;
    endCursor = data.posts?.pageInfo?.endCursor ?? null;

  }


  hasNextPage = true;
  endCursor = null;
  
  while (hasNextPage) {
    const response: Response = await fetch(
      "https://blog.rdldn.co.uk/graphql",
      {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          query: ALL_PAGE_SLUGS_QUERY,
          variables: {
            first: 100,
            after: endCursor,
          },
        }),
      }
    );

    const { data } = await response.json();
    const pages = data.pages.nodes;
    allPages.push(...pages);

    hasNextPage = data.pages.pageInfo.hasNextPage;
    endCursor = data.pages.pageInfo.endCursor;
  }

  const postPaths = allPosts.map((post) => ({
    params: { slug: post.slug },
    props: { contentType: "post" }
  }));

  const pagePaths = allPages.map((page) => ({
    params: { slug: page.slug },
    props: { contentType: "page" }
  }));

  return [...postPaths, ...pagePaths];
}

    const { slug } = Astro.params;
    const { contentType } = Astro.props;

const singleResponse = await fetch("https://blog.rdldn.co.uk/graphql", {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({
    query: contentType === "page" ? SINGLE_PAGE_QUERY(slug) : SINGLE_POST_QUERY(slug),
  }),
});

const { data } = await singleResponse.json();

const singlePost = contentType === "page" ? data.page : data.post;

if (!singlePost) {
  return Astro.redirect("/404", 302);
}

const CLOSED_STATUS_LABELS: Record<string, string> = {
  closeddown: "Closed Down",
  newmanagement: "Under New Management",
  newowners: "Under New Owners",
  popupmoved: "Popup Now Trading Elsewhere",
  popupstopped: "Popup Stopped Trading",
  tempclosed: "Temporarily Closed",
};

const closedDownId = singlePost.closedDowns?.nodes?.[0]?.name;

const getClosedMessage = () => {
  if (!closedDownId) return "";

  if (closedDownId.includes("re-reviewed")) {
    return `Re-reviewed: ${closedDownId.replace("re-reviewed-", "").trim()}`;
  }

  return CLOSED_STATUS_LABELS[closedDownId] ?? "Closed Down";
};

const currentYear = new Date().getFullYear();
const postYear = new Date(singlePost.date).getFullYear();
const postMoreThanTwoYearsOld = postYear < currentYear - 2;
const yearOfVisit = singlePost.yearsOfVisit?.nodes?.[0]?.name;
const price = singlePost.prices?.nodes?.[0]?.name;
const rating = singlePost.ratings?.nodes?.[0]?.name;
const tubeStation = singlePost.tubeStations?.nodes?.[0]?.name;
const tubeLines = singlePost.tubeLines?.nodes?.map((line: { name: string }) => line.name).join(", ");
const isRoastDinner = singlePost.typesOfPost?.nodes?.some((node: { name: string }) => node.name === "Roast Dinner");
const isRereviewed = closedDownId?.startsWith("re-reviewed");
/* istanbul ignore next */
const featuredImageUrl = singlePost.featuredImage?.node?.sourceUrl || logo3;

const threadedComments = organiseComments(
  contentType === "page" ? data.page.comments.nodes : data.post.comments.nodes
);
---

<BaseLayout
  pageTitle={singlePost.title}
  description={singlePost?.seo?.opengraphDescription}
  opengraphImage={singlePost.seo?.opengraphImage?.sourceUrl}
  halloween={singlePost.typesOfPost?.nodes?.some((node: { name: string }) => node.name === "Halloween") ? true : false}
>
  <div class="image-container">
    <img
      src={featuredImageUrl}
      alt={singlePost.title}
      width={5000}
      height={5000}
      class="featured-image"
      loading="eager"
    />
    {singlePost.closedDowns?.nodes?.length > 0 && (
      <div class="closed-overlay">
        {getClosedMessage()}
      </div>
    )}
    <div class="copyright-overlay">
      &copy; {new Date().getFullYear()} Roast Dinners in London. All rights reserved.
    </div>
  </div>
  <section class="post-title">
    <h2>{singlePost.title}</h2>
    <p>
      Published: {
        new Date(singlePost.date).toLocaleDateString("en-UK", {
          year: "numeric",
          month: "long",
          day: "numeric",
        })
      }
    </p>
  </section>
  <div class="container">
    {contentType === "post" && (
      <>
        <button
          class="skip"
          onclick="
            const el = document.getElementById('summary');
            if (el) {
              const y = el.getBoundingClientRect().top + window.pageYOffset - 120;
              window.scrollTo({ top: y, behavior: 'smooth' });
            }
          "
        >
          Skip The Nonsense
        </button>
        {postMoreThanTwoYearsOld && (
          <p class="warning">
            This post is from {postYear}. Maybe check some other reviews on Google Maps or something before booking.  If you have been since my visit, please let me know how it was in the comments below!
          </p>
        )}
        { singlePost.nSFWs?.nodes?.length > 0 && (
          <p class="nsfw">
            NSFW: Warning - this review may not be safe for work due to {singlePost.nSFWs.nodes.map((nsfw: { name: string}) => nsfw.name).join(", ")}.
          </p>
        )}
      </>
    )}
    
    <div set:html={singlePost.content?.replace(/i\d+\.wp\.com\/rdldn\.co\.uk/g, 'blog.rdldn.co.uk')} />

    <Newsletter />
    
    {contentType === "post" && isRoastDinner && (
    <section id="summary" class="summary">
              <h3>Summary:</h3>

      {singlePost.closedDowns?.nodes?.length > 0 && (
        <p class="closed-message">
          {getClosedMessage()}
        </p>
      )}
        <p>{singlePost.title}</p>
      <p class={isRereviewed ? "re-reviewed-rating" : ""}>
        Rating: {rating}
      </p>
      {tubeStation && <p>Tube Station: {tubeStation}</p> }
              <p>
        Tube Lines:{" "}
        {tubeLines}
      </p>
      <p>
        Price Paid{Number(yearOfVisit) !== currentYear
          ? ` (in ${yearOfVisit})`
          : ""}:
        {" "}{price}
      </p>
      <p>Year of Visit: {yearOfVisit}</p>
      {singlePost.owners?.nodes?.length > 0 && (
        <p>
          Chain{singlePost.owners.nodes.length > 1 ? "s" : ""}:{" "}
          {singlePost.owners.nodes.map((owner: { name: string }, index: number) => (
            <>
              <a href={`/chains/${toOwnerSlug(owner.name)}`}>{owner.name}</a>
              {index < singlePost.owners.nodes.length - 1 ? ", " : ""}
            </>
          ))}
        </p>
      )}
    </section>
    <section>
      <h3>Loved & Loathed:</h3>
      <p>Loved: {singlePost.highlights?.loved}</p>
      <p>Loathed: {singlePost.highlights?.loathed}</p>
    </section>
    <section>
      {singlePost.closedDowns?.nodes?.length === 0 && (
        <>
          <h3>Get Booking:</h3>
          {singlePost.highlights?.website && (
            <p>
              <a href={singlePost.highlights.website}>
                Book {singlePost.title}
              </a>
            </p>
          )}
          {singlePost.highlights?.instagram && (
            <p>
              <a href={singlePost.highlights.instagram}>
                Follow on Instagram
              </a>
            </p>
          )}
        </>
      )}
    </section>
    <RoastByTagSection
      type="location"
      tag={singlePost.boroughs?.nodes?.[0]?.name?.replace(/\s+/g, "-")}
    />

    <Comments threadedComments={threadedComments} postId={singlePost.postId} />

    )}

    {contentType === "page" && (
      <Comments threadedComments={threadedComments} postId={singlePost.pageId} />
    )}
  </div>
</BaseLayout>
