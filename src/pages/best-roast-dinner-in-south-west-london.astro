---
import BestRoastLayout from "../layouts/BestRoastLayout.astro";
export const prerender = true;

import { fetchGraphQL } from "../lib/api";
import { fetchPageData } from "../lib/graphql";
import GET_ALL_POSTS from "../lib/queries/getAllPosts";
import { organiseComments } from "../lib/utils";
import type { Post } from "../types";

const pageId = "5612";
const singlePage = await fetchPageData(pageId);

const getSouthWestTopRatedRoasts = async () => {
  const allPosts = [];
  let hasNextPage = true;
  let endCursor = null;

  while (hasNextPage) {
    const variables = endCursor ? { after: endCursor } : {};
    let postsResponse: {
      posts: {
        nodes: Post[];
        pageInfo: { hasNextPage: boolean; endCursor: string | null };
      };
    } | null;

    try {
      postsResponse = await fetchGraphQL(GET_ALL_POSTS, variables);
    } catch (error) {
      console.error("Error fetching posts:", error);
      break;
    }

    if (!postsResponse || !postsResponse.posts) {
      console.error("Invalid response from fetchGraphQL:", postsResponse);
      break;
    }

    const { posts } = postsResponse;

    const filtered = posts.nodes.filter((post: Post) => {
      const southWestLondonBoroughs = [
        "Merton",
        "Richmond upon Thames",
        "Kingston",
        "Wandsworth",
      ];
      const borough = post.boroughs?.nodes?.[0]?.name;
      const isClosed = post.closedDowns?.nodes[0]?.name || "";
      const rating = Number.parseFloat(post.ratings?.nodes?.[0]?.name || "");

      return (
        borough &&
        southWestLondonBoroughs.includes(borough) &&
        !isClosed &&
        !Number.isNaN(rating)
      );
    });

    allPosts.push(...filtered);
    hasNextPage = posts.pageInfo.hasNextPage;
    endCursor = posts.pageInfo.endCursor;
  }

  const topRated = allPosts
    .sort(
      (a, b) =>
        Number.parseFloat(b.ratings?.nodes?.[0]?.name || "") -
        Number.parseFloat(a.ratings?.nodes?.[0]?.name || "")
    )
    .slice(0, 5);

  const highRated = allPosts.filter(
    (post) =>
      Number.parseFloat(post.ratings?.nodes?.[0]?.name || "") >= 8 &&
      !topRated.some((topPost) => topPost.slug === post.slug)
  );

  return { topRated, highRated };
};

const { topRated, highRated } = await getSouthWestTopRatedRoasts();
const threadedComments = organiseComments(singlePage.comments.nodes);
---

<BestRoastLayout
  pageTitle={singlePage?.title}
  description={singlePage?.seo?.opengraphDescription}
  opengraphImage={singlePage?.seo?.opengraphImage?.sourceUrl}
  content={singlePage?.content}
  topRated={topRated}
  highRated={highRated}
  threadedComments={threadedComments}
  postId={singlePage?.pageId}
/>
