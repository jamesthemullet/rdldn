---
import BaseLayout from "../layouts/BaseLayout.astro";
import { organiseComments } from "../lib/utils";
import type { Page, Post } from "../types";
import "../styles/post.css";
import Comments from "../components/comments.astro";
import Newsletter from "../components/newsletter.astro";
import logo3 from "../images/logo-3.png";
import { fetchGraphQL } from "../lib/api";

export const prerender = true;

import { getSinglePageData } from "../lib/getSinglePageData";
import GET_ALL_POSTS from "../lib/queries/getAllPosts";
import { buildYearlyRoastStats, fetchAllPosts } from "../lib/yearlyRoastStats";

const variables = { id: "9147" };
const singlePage = await getSinglePageData({ variables });

const allRoastPosts = await fetchAllPosts(fetchGraphQL, GET_ALL_POSTS);
const greatRoastsByYear = buildYearlyRoastStats(
  allRoastPosts,
  (rating) => rating <= 6
);

const threadedComments = organiseComments(singlePage.comments.nodes);
---

<BaseLayout
  pageTitle={singlePage.title}
  description={singlePage?.seo?.opengraphDescription}
  opengraphImage={singlePage?.seo?.opengraphImage?.sourceUrl}
>
  <div class="image-container">
    <img
      src={singlePage?.featuredImage?.node?.sourceUrl}
      alt={singlePage.title}
      width={5000}
      height={5000}
      class="featured-image"
      loading="eager"
    />
    <div class="copyright-overlay">
      &copy; {new Date().getFullYear()} Roast Dinners in London. All rights reserved.
    </div>
  </div>
  <section class="post-title">
    <h2>{singlePage.title}</h2>
  </section>
  <div class="container">
    <div set:html={singlePage.content} />

    <ul>
      {
        Object.entries(greatRoastsByYear)
          .sort(([a], [b]) => b.localeCompare(a))
          .map(([year, { matching, total }]) => {
            const wasOrIs =
              year === String(new Date().getFullYear()) ? "is" : "was";
            const percentage =
              total > 0 ? Math.round((matching / total) * 100) : 0;
            return (
              <li>
                The number of really good roast dinners in {year} {wasOrIs}{" "}
                {matching} ({percentage}% of roasts).
              </li>
            );
          })
      }
    </ul>

    <Newsletter />
    <Comments threadedComments={threadedComments} postId={singlePage.pageId} />
  </div>
</BaseLayout>
