---
import BaseLayout from "../layouts/BaseLayout.astro";
export const prerender = true;

import { organiseComments } from "../lib/utils";
import type { Page, Post } from "../types";
import "../styles/post.css";
import Comments from "../components/comments.astro";
import Newsletter from "../components/newsletter.astro";
import logo3 from "../images/logo-3.png";
import { fetchGraphQL } from "../lib/api";
import GET_ALL_POSTS from "../lib/queries/getAllPosts";
import { getSinglePageData } from "../lib/getSinglePageData";

const variables = { id: "10544" };
const singlePage = await getSinglePageData({ variables });

type YearStats = Record<string, { total: number; count: number }>;

const yearStats: YearStats = {};

let hasNextPage = true;
let endCursor: string | null = null;

while (hasNextPage) {
  const variables = endCursor ? { after: endCursor } : {};
  const { posts } = await fetchGraphQL(GET_ALL_POSTS, variables);

  // b: <explanation>
  posts.nodes.forEach((post: Post) => {
    const year = post.yearsOfVisit?.nodes?.[0]?.name;
    const ratingStr = post.ratings?.nodes?.[0]?.name ?? "";
    const match = ratingStr.match(/[\d.]+/);
    const rating = match ? Number.parseFloat(match[0]) : null;

    if (!year || !rating || Number.isNaN(rating)) return;

    if (!yearStats[year]) {
      yearStats[year] = { total: 0, count: 0 };
    }

    yearStats[year].total += rating;
    yearStats[year].count++;
  });

  hasNextPage = posts.pageInfo.hasNextPage;
  endCursor = posts.pageInfo.endCursor;
}

const yearsSorted = Object.entries(yearStats)
  .map(([year, { total, count }]) => ({
    year,
    average: +(total / count).toFixed(2),
    count,
  }))
  .sort((a, b) => a.year.localeCompare(b.year));

const threadedComments = organiseComments(singlePage.comments.nodes);
---

<BaseLayout
  pageTitle={singlePage.title}
  description={singlePage?.seo?.opengraphDescription}
  opengraphImage={singlePage?.seo?.opengraphImage?.sourceUrl}
>
  <div class="image-container">
    <img
      src={singlePage?.featuredImage?.node?.sourceUrl || logo3.src}
      alt={singlePage.title}
      width={5000}
      height={5000}
      class="featured-image"
      loading="eager"
    />
    <div class="copyright-overlay">
      &copy; {new Date().getFullYear()} Roast Dinners in London. All rights reserved.
    </div>
  </div>
  <section class="post-title">
    <h2>{singlePage.title}</h2>
  </section>
  <div class="container">
    <div set:html={singlePage.content} />
    <ul>
      {
        yearsSorted.map(({ year, average, count }) => (
          <li>
            The average rating in {year} is {average.toFixed(2)} ({count}{" "}
            {count === 1 ? "review" : "reviews"})
          </li>
        ))
      }
    </ul>

    <Newsletter />
    <Comments threadedComments={threadedComments} postId={singlePage.pageId} />
  </div>
</BaseLayout>
