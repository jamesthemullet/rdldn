---
type Props = {
  resultLimit: number;
};

const { resultLimit = 4 } = Astro.props;
---

<div x-data="searchComponent" data-result-limit={resultLimit}>
  <form @submit.prevent="handleSearch">
    <input
      type="text"
      placeholder="Search..."
      x-model="searchTerm"
      required
      style="margin-left: 20px"
    />
    <button type="submit">Search</button>
  </form>

  <section class="home-list search-container" x-show="searchResults.length > 0">
    <ul>
      <template x-for="post in searchResults" :key="post.slug">
        <li class="heading">
          <h3>
            <a :href="`/${post.slug}`" x-text="post.title"></a>
          </h3>

          <a
            :href="`/${post.slug}`"
            rel="noopener noreferrer"
            class="featured-image"
          >
            <img
              :src="post.featuredImage?.node?.sourceUrl"
              :alt="`Photo of the roast dinner at ${post.title}`"
              width="400"
              height="300"
            />
          </a>
        </li>
      </template>
    </ul>
  </section>
  <p x-show="searchPerformed && searchResults.length === 0">
    No results found.
  </p>
</div>

<script is:inline>
  document.addEventListener("alpine:init", () => {
    Alpine.data("searchComponent", () => ({
      searchTerm: "",
      searchResults: [],
      searchPerformed: false,
      resultLimit: 4,

      init() {
        const limit = this.$el.dataset.resultLimit;
        this.resultLimit = Number(limit) || 4;
      },

      async handleSearch() {
        const response = await fetch("https://blog.rdldn.co.uk/graphql", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            query: `
              query SearchPosts($search: String!, $first: Int!) {
                posts(where: { search: $search }, first: $first) {
                  nodes { title
                  slug
                  featuredImage {
                    node {
                      sourceUrl
                    }
                  } }
                }
              }
            `,
            variables: {
              search: this.searchTerm,
              first: this.resultLimit,
            },
          }),
        });

        const json = await response.json();
        this.searchResults = json.data.posts.nodes || [];
        this.searchPerformed = true;
      },
    }));
  });
</script>
